# üß© Batfish Validation Module

## üìò Overview

This module is responsible for **validating and verifying network configurations** generated by a Large Language Model (LLM).  
Since LLMs may produce incomplete or incorrect configurations, the goal of this component is to automatically check the **correctness, consistency, and connectivity** of the generated configurations using **Batfish**.

It ensures that:
- The **topology** is consistent,  
- The **routing and interfaces** are correctly configured, and  
- The **end-to-end communication** between hosts remains functional after configuration changes.

---

## ‚öôÔ∏è Architecture

The Batfish validation module is implemented as a **Flask API** that interacts with the **Batfish network analysis engine**.


### üß© Components
| File | Description |
|------|--------------|
| **validator.py** | Flask web service that handles Batfish sessions, runs validation queries, and returns results. |
| **topology.json** | Defines the logical connections between all network devices. |
| **R1.txt, R2.txt** | Example router configuration files. |
| **h1.json, h2.json** | Host definitions used for reachability testing. |
| **requirements.txt** | Python dependencies (Flask, PyBatfish, etc.). |

---

## üß† How It Works

1. The **LLM** proposes configuration changes (for example, new OSPF commands).  
2. These proposed changes are sent to the Flask API via a POST request.  
3. The API creates a **temporary Batfish snapshot** that includes all device configurations and the topology.  
4. Batfish analyzes the snapshot and runs three checks:
   - **Control Plane (CP)** ‚Äî interface and routing consistency  
   - **Topology (TP)** ‚Äî structure and link correctness  
   - **Reachability (REACH)** ‚Äî connectivity between source and destination hosts  
5. The results are returned as a JSON report with PASS/FAIL for each test.

---

## üöÄ Quick Start

### 1. Start with Docker Compose (Recommended)
```bash
cd c:\Users\enmoh\Desktop\P003-LLM\03_AGENT_VALIDATION\batfish
docker compose up --build -d
```

This starts:
- **Batfish container** on ports 8888, 9997, 9996
- **Validator API** on port 5000

### 2. Check Status
```bash
docker compose ps
docker compose logs -f validator
```

### 3. Test the Service
```bash
curl http://localhost:5000/health
```

---

## üìÅ Project Structure

```
03_AGENT_VALIDATION/batfish/
‚îú‚îÄ‚îÄ docker-compose.yml      # Orchestrates Batfish + Validator
‚îú‚îÄ‚îÄ Dockerfile              # Validator service image
‚îú‚îÄ‚îÄ validator.py            # Flask API for validation
‚îú‚îÄ‚îÄ requirements.txt        # Python dependencies
‚îú‚îÄ‚îÄ configs/                # Base network configurations
‚îÇ   ‚îú‚îÄ‚îÄ R1.cfg
‚îÇ   ‚îú‚îÄ‚îÄ R2.cfg
‚îÇ   ‚îî‚îÄ‚îÄ R3.cfg
‚îî‚îÄ‚îÄ README.md
```

---

## üîß Configuration

### Environment Variables

Configure in `docker-compose.yml` or via environment:

| Variable | Default | Description |
|----------|---------|-------------|
| `BATFISH_HOST` | `batfish` | Hostname of Batfish container |
| `BF_NETWORK_NAME` | `network-test` | Batfish network name |
| `BF_SNAPSHOT_BASE` | `/app/configs` | Base config directory |
| `PORT` | `5000` | Validator API port |
| `REACH_SRC` | `h1` | Default source for reachability |
| `REACH_DST` | `h2` | Default destination for reachability |

### Custom Ports

Edit `docker-compose.yml`:
```yaml
services:
  validator:
    ports:
      - "9000:5000"  # Change external port
```

---

## üì° API Reference

### `POST /evaluate`

Validate network configuration changes.

**Request Body:**
```json
{
  "changes": {
    "R1": [
      "interface GigabitEthernet0/0",
      "ip address 10.0.1.1 255.255.255.0"
    ],
    "R2": [
      "router ospf 1",
      "network 10.0.0.0 0.0.0.255 area 0"
    ]
  },
  "intent": {
    "reach": [
      {"src": "h1", "dst": "h2"}
    ]
  }
}
```

**Response:**
```json
{
  "result": "OK",
  "snapshot": "snapshot-verify-abc123",
  "summary": {
    "CP": {
      "status": "PASS",
      "rows": 24
    },
    "TP": {
      "status": "PASS",
      "edges": 8
    },
    "REACH": [
      {
        "src": "h1",
        "dst": "h2",
        "status": "PASS"
      }
    ]
  }
}
```

### `GET /health`

Health check endpoint.

**Response:**
```json
{
  "status": "up"
}
```

---

## üöÄ Access API Documentation

Start validator:
```bash
cd 03_AGENT_VALIDATION/batfish
python validator.py
```

Open Swagger UI:
- **Interactive Docs**: http://localhost:5000/docs
- **Alternative (ReDoc)**: http://localhost:5000/redoc
- **Health Check**: http://localhost:5000/health

### Test with Swagger UI:
1. Navigate to http://localhost:5000/docs
2. Expand `POST /evaluate`
3. Click "Try it out"
4. Use example payload or modify
5. Click "Execute"
6. Review response

### Example curl test:
```bash
curl -X POST http://localhost:5000/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "changes": {
      "R1": ["interface Loopback0", " ip address 10.1.1.1 255.255.255.255"],
      "R2": ["interface Loopback0", " ip address 10.2.2.2 255.255.255.255"]
    },
    "intent": {
      "reach": [{"src": "R1", "dst": "R2"}]
    }
  }'
```

# Team 3 - Batfish Validator

Network configuration validation using Batfish simulation.

---

## üöÄ Quick Start

```bash
docker compose up --build -d
curl http://localhost:5000/health
```

---

## üêõ Common Errors

### "A Batfish nodeSpec must be a string"

**Error:**
```
Expected type: 'nodeSpec' for parameter: 'nodes'. Got error: 'A Batfish nodeSpec must be a string'
```

**Cause:**  
The validator passed a Python list/set to Batfish, but it expects a comma-separated string.

**Fix:**  
Already applied in `validator.py` - `_run_cp()` now converts device lists to strings:
```python
nodes_spec = ",".join(str(d) for d in changed_devices)
```

**Verify Fix:**
```bash
docker logs validator | grep "CP check for nodes"
# Should show: CP check for nodes: R1,R2,R3
```

---

### Base Snapshot Missing

**Error:**
```
COPY_BASE_SNAPSHOT failed: [Errno 2] No such file or directory
```

**Fix:**
```bash
# Ensure base snapshot exists
ls 03_AGENT_VALIDATION/batfish/configs/

# Should contain: *.cfg files for base topology
```

---

### Batfish Not Ready

**Error:**
```
Batfish not ready after timeout
```

**Fix:**
```bash
# Increase timeout
docker compose down
# Edit docker-compose.yml: BATFISH_READY_TIMEOUT=180
docker compose up -d

# Check Batfish logs
docker logs batfish
```

---

## üìù API Reference

### POST /evaluate

**Payload:**
```json
{
  "changes": {
    "R1": ["router ospf 1", "network 10.0.0.0 0.0.0.255 area 0"],
    "R2": ["router ospf 1", "network 10.0.1.0 0.0.0.255 area 0"]
  },
  "intent": {
    "reach": [
      {"src": "R1", "dst": "R2"}
    ]
  }
}
```

**Response (Success):**
```json
{
  "result": "OK",
  "snapshot": "snapshot-verify-abc123",
  "summary": {
    "CP": {"status": "PASS", "rows": 6},
    "TP": {"status": "PASS", "edges": 3},
    "REACH": [
      {"src": "R1", "dst": "R2", "status": "PASS", "error": ""}
    ]
  }
}
```

**Response (Error):**
```json
{
  "result": "ERROR",
  "stage": "VERIFY",
  "error": "A Batfish nodeSpec must be a string",
  "trace": ["..."],
  "changed_devices": ["R1", "R2"],
  "reach_paths": [{"src": "R1", "dst": "R2"}]
}
```