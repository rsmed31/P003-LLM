# üß© Batfish Validation Module

## üìò Overview

This module is responsible for **validating and verifying network configurations** generated by a Large Language Model (LLM).  
Since LLMs may produce incomplete or incorrect configurations, the goal of this component is to automatically check the **correctness, consistency, and connectivity** of the generated configurations using **Batfish**.

It ensures that:
- The **topology** is consistent,  
- The **routing and interfaces** are correctly configured, and  
- The **end-to-end communication** between hosts remains functional after configuration changes.

---

## ‚öôÔ∏è Architecture

The Batfish validation module is implemented as a **Flask API** that interacts with the **Batfish network analysis engine**.


### üß© Components
| File | Description |
|------|--------------|
| **validator.py** | Flask web service that handles Batfish sessions, runs validation queries, and returns results. |
| **topology.json** | Defines the logical connections between all network devices. |
| **R1.txt, R2.txt** | Example router configuration files. |
| **h1.json, h2.json** | Host definitions used for reachability testing. |
| **requirements.txt** | Python dependencies (Flask, PyBatfish, etc.). |

---

## üß† How It Works

1. The **LLM** proposes configuration changes (for example, new OSPF commands).  
2. These proposed changes are sent to the Flask API via a POST request.  
3. The API creates a **temporary Batfish snapshot** that includes all device configurations and the topology.  
4. Batfish analyzes the snapshot and runs three checks:
   - **Control Plane (CP)** ‚Äî interface and routing consistency  
   - **Topology (TP)** ‚Äî structure and link correctness  
   - **Reachability (REACH)** ‚Äî connectivity between source and destination hosts  
5. The results are returned as a JSON report with PASS/FAIL for each test.

---

## üöÄ Quick Start

### 1. Start with Docker Compose (Recommended)
```bash
cd c:\Users\enmoh\Desktop\P003-LLM\03_AGENT_VALIDATION\batfish
docker compose up --build -d
```

This starts:
- **Batfish container** on ports 8888, 9997, 9996
- **Validator API** on port 5000

### 2. Check Status
```bash
docker compose ps
docker compose logs -f validator
```

### 3. Test the Service
```bash
curl http://localhost:5000/health
```

---

## üìÅ Project Structure

```
03_AGENT_VALIDATION/batfish/
‚îú‚îÄ‚îÄ docker-compose.yml      # Orchestrates Batfish + Validator
‚îú‚îÄ‚îÄ Dockerfile              # Validator service image
‚îú‚îÄ‚îÄ validator.py            # Flask API for validation
‚îú‚îÄ‚îÄ requirements.txt        # Python dependencies
‚îú‚îÄ‚îÄ configs/                # Base network configurations
‚îÇ   ‚îú‚îÄ‚îÄ R1.cfg
‚îÇ   ‚îú‚îÄ‚îÄ R2.cfg
‚îÇ   ‚îî‚îÄ‚îÄ R3.cfg
‚îî‚îÄ‚îÄ README.md
```

---

## üîß Configuration

### Environment Variables

Configure in `docker-compose.yml` or via environment:

| Variable | Default | Description |
|----------|---------|-------------|
| `BATFISH_HOST` | `batfish` | Hostname of Batfish container |
| `BF_NETWORK_NAME` | `network-test` | Batfish network name |
| `BF_SNAPSHOT_BASE` | `/app/configs` | Base config directory |
| `PORT` | `5000` | Validator API port |
| `REACH_SRC` | `h1` | Default source for reachability |
| `REACH_DST` | `h2` | Default destination for reachability |

### Custom Ports

Edit `docker-compose.yml`:
```yaml
services:
  validator:
    ports:
      - "9000:5000"  # Change external port
```

---

## üì° API Reference

### `POST /evaluate`

Validate network configuration changes.

**Request Body:**
```json
{
  "changes": {
    "R1": [
      "interface GigabitEthernet0/0",
      "ip address 10.0.1.1 255.255.255.0"
    ],
    "R2": [
      "router ospf 1",
      "network 10.0.0.0 0.0.0.255 area 0"
    ]
  },
  "intent": {
    "reach": [
      {"src": "h1", "dst": "h2"}
    ]
  }
}
```

**Response:**
```json
{
  "result": "OK",
  "snapshot": "snapshot-verify-abc123",
  "summary": {
    "CP": {
      "status": "PASS",
      "rows": 24
    },
    "TP": {
      "status": "PASS",
      "edges": 8
    },
    "REACH": [
      {
        "src": "h1",
        "dst": "h2",
        "status": "PASS"
      }
    ]
  }
}
```

### `GET /health`

Health check endpoint.

**Response:**
```json
{
  "status": "up"
}
```

---

## üêõ Troubleshooting

### Batfish container not starting
```bash
# Check Batfish logs
docker compose logs batfish

# Restart Batfish
docker compose restart batfish
```

### Validator can't connect to Batfish
```bash
# Verify network connectivity
docker compose exec validator ping batfish

# Check Batfish health
docker compose exec validator curl http://batfish:9996/
```

### Config files not found
```bash
# Ensure configs directory exists and has files
ls -la configs/

# Check volume mount
docker compose exec validator ls -la /app/configs/
```

### Permission issues with volumes
```bash
# Reset volumes
docker compose down -v
docker compose up --build
```

---

## üß™ Testing

### Test with Sample Data
```bash
curl -X POST http://localhost:5000/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "changes": {
      "R1": ["interface lo0", "ip address 1.1.1.1 255.255.255.255"]
    },
    "intent": {
      "reach": [{"src": "R1", "dst": "R2"}]
    }
  }' | python -m json.tool
```

### Integration Test via Agent
```bash
cd ../../langchain_agent
python agent_service.py --query "Configure OSPF on 3 routers"
```

---

## üîÑ Updating Configurations

### Add New Base Config
```bash
# Create new device config
echo "hostname R4" > configs/R4.cfg

# Restart validator to pick up changes
docker compose restart validator
```

### Reset to Clean State
```bash
# Stop and remove volumes
docker compose down -v

# Rebuild and start
docker compose up --build -d
```

---

## üê≥ Docker Commands Reference

### Basic Operations
```bash
# Start services
docker compose up -d

# Stop services
docker compose stop

# Remove containers (keeps volumes)
docker compose down

# Remove everything including volumes
docker compose down -v

# View logs
docker compose logs -f [service_name]

# Restart a service
docker compose restart [service_name]
```

### Development
```bash
# Rebuild after code changes
docker compose up --build

# Execute commands in container
docker compose exec validator python -c "print('test')"

# Access container shell
docker compose exec validator /bin/bash
```

### Debugging
```bash
# Check container status
docker compose ps

# Inspect volumes
docker volume ls
docker volume inspect batfish_batfish-data

# View resource usage
docker stats
```

---

## üîó Integration with Makefile

The master Makefile includes commands for this service:

```bash
# From project root (P003-LLM/)
make run-t3           # Start validator with Docker Compose
make logs-t3          # View validator logs
make stop             # Stop all services including validator
```

---

## üì¶ Batfish Data Persistence

Batfish data is stored in a named volume `batfish-data`:

```bash
# Backup Batfish data
docker run --rm -v batfish_batfish-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/batfish-backup.tar.gz -C /data .

# Restore Batfish data
docker run --rm -v batfish_batfish-data:/data -v $(pwd):/backup \
  alpine tar xzf /backup/batfish-backup.tar.gz -C /data
```

---

## üö® Production Considerations

1. **Resource Limits**: Add to `docker-compose.yml`:
   ```yaml
   services:
     batfish:
       deploy:
         resources:
           limits:
             cpus: '2.0'
             memory: 4G
   ```

2. **Security**: Don't expose Batfish ports publicly (remove port mappings for 9996, 9997)

3. **Monitoring**: Add health checks and alerts

4. **Logging**: Configure log rotation:
   ```yaml
   services:
     validator:
       logging:
         driver: "json-file"
         options:
           max-size: "10m"
           max-file: "3"
   ```

---

## üìå Version

**Batfish Image:** `batfish/allinone:latest`  
**Validator Version:** 1.0.0  
**Last Updated:** 2025
